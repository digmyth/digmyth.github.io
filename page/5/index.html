<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Welcome to wxq&#39;s Blog created in 2017-01-01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:url" content="http://www.digmyth.com/page/5/index.html">
<meta property="og:site_name" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
  
    <link rel="alternate" href="/atom.xml" title="Welcome to wxq&#39;s Blog created in 2017-01-01" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Welcome to wxq&#39;s Blog created in 2017-01-01</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.digmyth.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-log_helm-efk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/15/log_helm-efk/" class="article-date">
  <time datetime="2019-10-15T02:42:36.000Z" itemprop="datePublished">2019-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/日志系统/">日志系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/15/log_helm-efk/">helm部署efk日志系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>efk 日志系统<br>3大组件<br>elasticsearch<br>fluent-bit<br>kibana</p>
<p>helm部署efk日志系统<br>heml.sh  官网<br><a href="https://artifacthub.io/packages/helm/bitnami/elasticsearch" target="_blank" rel="noopener">https://artifacthub.io/packages/helm/bitnami/elasticsearch</a>    搜索elasticsearch Charts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster efk]# helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">&quot;bitnami&quot; has been added to your repositories</span><br><span class="line">[root@k8smaster efk]# helm repo list</span><br><span class="line">NAME   	URL                                  </span><br><span class="line">loki   	https://grafana.github.io/loki/charts</span><br><span class="line">stable 	https://charts.helm.sh/stable        </span><br><span class="line">bitnami	https://charts.bitnami.com/bitnami</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster efk]# helm search repo elastic</span><br><span class="line">NAME                         	CHART VERSION	APP VERSION	DESCRIPTION                                       </span><br><span class="line">bitnami/elasticsearch        	14.5.0       	7.10.2     	A highly scalable open-source full-text search ...</span><br><span class="line"></span><br><span class="line"> helm  show values  bitnami/elasticsearch &gt; es_values.yaml</span><br></pre></td></tr></table></figure>
<p>有人说k8s 中的APP JDK 最好11以上， data.resources  +1G  = data.heapsize 这个预留一个G给进程使用，其它才给JVM使用性能更佳<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster efk]# helm install  myes bitnami/elasticsearch -f es_values.yaml  -n logs</span><br><span class="line">NAME: myes</span><br><span class="line">LAST DEPLOYED: Tue Mar 16 10:34:09 2021</span><br><span class="line">NAMESPACE: logs</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"> WARNING</span><br><span class="line"></span><br><span class="line">    Elasticsearch requires some changes in the kernel of the host machine to</span><br><span class="line">    work as expected. If those values are not set in the underlying operating</span><br><span class="line">    system, the ES containers fail to boot with ERROR messages.</span><br><span class="line"></span><br><span class="line">    More information about these requirements can be found in the links below:</span><br><span class="line"></span><br><span class="line">      https://www.elastic.co/guide/en/elasticsearch/reference/current/file-descriptors.html</span><br><span class="line">      https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html</span><br><span class="line"></span><br><span class="line">    This chart uses a privileged initContainer to change those settings in the Kernel</span><br><span class="line">    by running: sysctl -w vm.max_map_count=262144 &amp;&amp; sysctl -w fs.file-max=65536</span><br><span class="line"></span><br><span class="line">** Please be patient while the chart is being deployed **</span><br><span class="line"></span><br><span class="line">  Elasticsearch can be accessed within the cluster on port 9200 at myes-elasticsearch-coordinating-only.logs.svc.cluster.local</span><br><span class="line"></span><br><span class="line">  To access from outside the cluster execute the following commands:</span><br><span class="line"></span><br><span class="line">    kubectl port-forward --namespace logs svc/myes-elasticsearch-coordinating-only 9200:9200 &amp;</span><br><span class="line">    curl http://127.0.0.1:9200/</span><br></pre></td></tr></table></figure></p>
<p>部署日志采集agent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster efk]# helm  search  repo elas</span><br><span class="line">NAME                         	CHART VERSION	APP VERSION	DESCRIPTION                                       </span><br><span class="line">bitnami/elasticsearch        	14.5.0       	7.10.2     	A highly scalable open-source full-text search ...</span><br><span class="line">stable/elastabot             	1.2.1        	1.1.0      	DEPRECATED A Helm chart for Elastabot - a Slack...</span><br><span class="line">stable/elastalert            	1.5.1        	0.2.4      	DEPRECATED ElastAlert is a simple framework for...</span><br><span class="line">stable/elastic-stack         	2.0.6        	6          	DEPRECATED A Helm chart for ELK                   </span><br><span class="line">stable/elasticsearch         	1.32.5       	6.8.6      	DEPRECATED Flexible and powerful open source, d...</span><br><span class="line">stable/elasticsearch-curator 	2.2.3        	5.7.6      	DEPRECATED A Helm chart for Elasticsearch Curator </span><br><span class="line">stable/elasticsearch-exporter	3.7.1        	1.1.0      	DEPRECATED Elasticsearch stats exporter for Pro...</span><br><span class="line">stable/fluentd-elasticsearch 	2.0.7        	2.3.2      	DEPRECATED! - A Fluentd Helm chart for Kubernet...</span><br><span class="line">bitnami/grafana              	5.2.4        	7.4.3      	Grafana is an open source, feature rich metrics...</span><br><span class="line">bitnami/kibana               	7.2.3        	7.10.2     	Kibana is an open source, browser based analyti...</span><br><span class="line">stable/apm-server            	2.1.7        	7.0.0      	DEPRECATED The server receives data from the El...</span><br><span class="line">stable/dmarc2logstash        	1.3.1        	1.0.3      	DEPRECATED Provides a POP3-polled DMARC XML rep...</span><br><span class="line">stable/fluentd               	2.5.3        	v2.4.0     	DEPRECATED A Fluentd Elasticsearch Helm chart f...</span><br><span class="line">stable/kibana                	3.2.8        	6.7.0      	DEPRECATED - Kibana is an open source data visu...</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster efk]# helm show values  bitnami/kibana &gt; kibana_values.yaml</span><br><span class="line">[root@k8smaster efk]# vim kibana_values.yaml</span><br><span class="line">[root@k8smaster efk]# helm install kibanaui bitnami/kibana -f kibana_values.yaml  -n logs</span><br><span class="line">NAME: kibanaui</span><br><span class="line">LAST DEPLOYED: Tue Mar 16 15:21:01 2021</span><br><span class="line">NAMESPACE: logs</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">NOTES:</span><br><span class="line">1. Get the application URL by running these commands:</span><br><span class="line">  Get the Kibana URL and associate Kibana hostname to your cluster external IP:</span><br><span class="line"></span><br><span class="line">   export CLUSTER_IP=$(minikube ip) # On Minikube. Use: `kubectl cluster-info` on others K8s clusters</span><br><span class="line">   echo &quot;Kibana URL: http://kibana.local/&quot;</span><br><span class="line">   echo &quot;$CLUSTER_IP  kibana.local&quot; | sudo tee -a /etc/hosts</span><br><span class="line"></span><br><span class="line">WARNING: Kibana is externally accessible from the cluster but the dashboard does not contain authentication mechanisms. Make sure you follow the authentication guidelines in your Elastic stack.</span><br><span class="line">+info https://www.elastic.co/guide/en/elastic-stack-overview/current/setting-up-authentication.html</span><br><span class="line">WARNING: Rolling tag detected (bitnami/bitnami-shell:10), please note that it is strongly recommended to avoid using rolling tags in a production environment.</span><br><span class="line">+info https://docs.bitnami.com/containers/how-to/understand-rolling-tags-containers/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br><span class="line">helm repo list </span><br><span class="line">helm search repo fluent-bit</span><br><span class="line">helm show values fluent/fluent-bit  &gt; fluent-bit-values.yaml</span><br><span class="line">helm install  -f fluent-bit-values.yaml -n logs</span><br><span class="line">helm list -n logs</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>helm安装好处是一键安装，坏处是自定义容器内yml配置文件难度极大，如果helm charts提供的原始配置文件里没有(此处不是说修改values.yml值文件),需要重新制作charts部署</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/10/15/log_helm-efk/" data-id="cksr304cc003obpjx9bnpdemp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-log_elasticsearch_api" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/15/log_elasticsearch_api/" class="article-date">
  <time datetime="2019-09-15T02:22:36.000Z" itemprop="datePublished">2019-09-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/日志系统/">日志系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/15/log_elasticsearch_api/">elasticsearch API</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><p>搜索引擎包括： 索引组件、搜索组件<br>索引组件： 面向数据存储和索引构建<br>搜索组件： 面向用户提供搜索功能以及将用户提供的搜索请求转换成可用的查询语句并通过索引完成查询过程或搜索过程<br>其中一种著名的索引叫做倒排索引</p>
<p>获取数据的组件：工作在pull拉取数据模式， solr/Nutch/grub/Apeture<br>ES: 索引index、类型type、文档document、映射mapping<br>    每个索引的分片数量： 5<br>    每个分片也应该有副本： 1<br>用户接口：  9200/tcp<br>集群接口：  9300/tcp</p>
<p>数据类型： string、number、boolean、date、</p>
<p>ES中搜索的数据广义上可被分为2类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exact:  精确查找，指在原始数据上精确查找</span><br><span class="line">full-text:  全文查找，判断文档在多大程度上匹配查询请求，用于评估文档与用户查询请求的相似度</span><br></pre></td></tr></table></figure></p>
<p>为了完成full-text搜索，ES必须先分析文本并创建出倒排索引，倒排索引中的数据还需要进行“正规化”为标准格式：<br>如单词复数改为单数，助词去掉，这样的分词加正规化的过程即为分析，分析是需要分析器analyzer工作的<br>分析器由3个组件构成： 字符过滤器、分词器、分词过滤器<br>ES内置的分析器有:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">standard analyzer (default analyzer)</span><br><span class="line">simple analyzer</span><br><span class="line">whitespace analyzer</span><br><span class="line">language analyzer</span><br></pre></td></tr></table></figure></p>
<p>分析器不仅在创建索引时用到，在构建查询时也会用到并且前后二者的分析器必须一致，否则无法解析</p>
<h3 id="API调用"><a href="#API调用" class="headerlink" title="API调用"></a>API调用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cat/indices</span><br><span class="line">green open .kibana_task_manager_7.12.0_001 1U4c04_oR--NoqAssK-GhQ 1 1  9 1628 579.3kb  344kb</span><br><span class="line">green open .apm-custom-link                pxk-mw7-TrSbOOkq-YtGDA 1 1  0    0    416b   208b</span><br><span class="line">green open .apm-agent-configuration        qXAmtdt-Sxme3_b4dAXDrA 1 1  0    0    416b   208b</span><br><span class="line">green open .kibana_7.12.0_001              dnQirVu_SFukMa2QEvx5ig 1 1 45   14   4.3mb  2.1mb</span><br><span class="line">green open .kibana-event-log-7.12.0-000001 x2AirAinS8qVwxFEVEyaVQ 1 1  3    0  32.9kb 16.4kb</span><br><span class="line">green open .tasks                          JpRquzGeQLWuWLBhT6XTHQ 1 1  4    0  48.7kb 27.3kb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cat/health</span><br><span class="line">1618472240 07:37:20 es-docker-cluster green 3 3 14 7 0 0 0 0 - 100.0%</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cluster/health?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;cluster_name&quot; : &quot;es-docker-cluster&quot;,</span><br><span class="line">  &quot;status&quot; : &quot;green&quot;,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;number_of_nodes&quot; : 3,</span><br><span class="line">  &quot;number_of_data_nodes&quot; : 3,</span><br><span class="line">  &quot;active_primary_shards&quot; : 7,</span><br><span class="line">  &quot;active_shards&quot; : 14,</span><br><span class="line">  &quot;relocating_shards&quot; : 0,</span><br><span class="line">  &quot;initializing_shards&quot; : 0,</span><br><span class="line">  &quot;unassigned_shards&quot; : 0,</span><br><span class="line">  &quot;delayed_unassigned_shards&quot; : 0,</span><br><span class="line">  &quot;number_of_pending_tasks&quot; : 0,</span><br><span class="line">  &quot;number_of_in_flight_fetch&quot; : 0,</span><br><span class="line">  &quot;task_max_waiting_in_queue_millis&quot; : 0,</span><br><span class="line">  &quot;active_shards_percent_as_number&quot; : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cluster/state/master_node?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;cluster_name&quot; : &quot;es-docker-cluster&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;exgsV0fDSCu826nXkN9w8A&quot;,</span><br><span class="line">  &quot;master_node&quot; : &quot;WIm1WA75QhSegglRpCn4-Q&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cluster/state/nodes?pretty</span><br><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cluster/stats?pretty</span><br><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_nodes/stats?pretty</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cluster/pending_tasks?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tasks&quot; : [ ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -H &quot;Content-Type: application/json&quot;  -X PUT  http://192.168.1.40:9200/students/class1/1?pretty -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;first_name&quot;: &quot;jing&quot;,</span><br><span class="line">&quot;last_name&quot;: &quot;Huang&quot;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 0,</span><br><span class="line">  &quot;_primary_term&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -H &quot;Content-Type: application/json&quot;  -X PUT  http://192.168.1.40:9200/students/class1/2?pretty -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;first_name&quot;: &quot;jing2&quot;,</span><br><span class="line">&quot;last_name&quot;: &quot;Huang2&quot;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;students&quot;,  # 索引，没有会自动创建</span><br><span class="line">  &quot;_type&quot; : &quot;class1&quot;,  # 类型，没有会自动创建</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 2,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 1,</span><br><span class="line">  &quot;_primary_term&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取文档数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -X  GET http://192.168.1.40:9200/students/class1/1</span><br><span class="line">&#123;&quot;_index&quot;:&quot;students&quot;,&quot;_type&quot;:&quot;class1&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:1,&quot;_seq_no&quot;:0,&quot;_primary_term&quot;:1,&quot;found&quot;:true,&quot;_source&quot;:</span><br><span class="line">&#123;</span><br><span class="line">&quot;first_name&quot;: &quot;jing&quot;,</span><br><span class="line">&quot;last_name&quot;: &quot;Huang&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;[root@node01 ~]# curl -X  GET http://192.168.1.40:9200/students/class1/2</span><br><span class="line">&#123;&quot;_index&quot;:&quot;students&quot;,&quot;_type&quot;:&quot;class1&quot;,&quot;_id&quot;:&quot;2&quot;,&quot;_version&quot;:1,&quot;_seq_no&quot;:1,&quot;_primary_term&quot;:1,&quot;found&quot;:true,&quot;_source&quot;:</span><br><span class="line">&#123;</span><br><span class="line">&quot;first_name&quot;: &quot;jing2&quot;,</span><br><span class="line">&quot;last_name&quot;: &quot;Huang2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更新文档可以PUT方法覆盖原有文档，也可以局部更新用POST方法调用_update接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -H &quot;Content-Type: application/json&quot;  -X POST http://192.168.1.40:9200/students/class1/2/_update?pretty -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;doc&quot;: &#123;&quot;last_name&quot;: &quot;Huang2_222&quot;&#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;result&quot; : &quot;noop&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 0,</span><br><span class="line">    &quot;successful&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 2,</span><br><span class="line">  &quot;_primary_term&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">[root@node01 ~]# curl -X GET http://192.168.1.40:9200/students/class1/2?pretty  # 查看更新</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;_seq_no&quot; : 2,</span><br><span class="line">  &quot;_primary_term&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;first_name&quot; : &quot;jing2&quot;,</span><br><span class="line">    &quot;last_name&quot; : &quot;Huang2_222&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>删除文档<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -X DELETE  http://192.168.1.40:9200/students/class1/2</span><br></pre></td></tr></table></figure></p>
<p>查看索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -X GET  http://192.168.1.40:9200/_cat/indices?v</span><br><span class="line">health status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   .kibana_task_manager_7.12.0_001 1U4c04_oR--NoqAssK-GhQ   1   1          9          431      1.3mb        630.3kb</span><br><span class="line">green  open   .apm-custom-link                pxk-mw7-TrSbOOkq-YtGDA   1   1          0            0       416b           208b</span><br><span class="line">green  open   .apm-agent-configuration        qXAmtdt-Sxme3_b4dAXDrA   1   1          0            0       416b           208b</span><br><span class="line">green  open   students                        em-XgwfsSc--wFnCcLC7jg   1   1          2            0     21.5kb          8.6kb</span><br><span class="line">green  open   .kibana-event-log-7.12.0-000001 x2AirAinS8qVwxFEVEyaVQ   1   1          4            0     43.7kb         21.8kb</span><br><span class="line">green  open   .kibana_7.12.0_001              dnQirVu_SFukMa2QEvx5ig   1   1         45            4      4.2mb          2.1mb</span><br><span class="line">green  open   .tasks                          JpRquzGeQLWuWLBhT6XTHQ   1   1          6            0     75.8kb         40.9kb</span><br></pre></td></tr></table></figure></p>
<p>删除索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]#  curl -X DELETE http://192.168.1.40:9200/students/</span><br><span class="line">&#123;&quot;acknowledged&quot;:true&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上是基于query DSL language,用于实现诸多类型查询<br>向ES发起查询请求的方式有2种：<br>1 通过RestFul request API查询，也称为query     string<br>2 通过发送REST request body 进行查询</p>
<p>query     string方式查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl http://192.168.1.40:9200/students/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 4,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 2,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;first_name&quot; : &quot;jing&quot;,</span><br><span class="line">          &quot;last_name&quot; : &quot;Huang&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;first_name&quot; : &quot;jing2&quot;,</span><br><span class="line">          &quot;last_name&quot; : &quot;Huang2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>REST request body 方式查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -H &quot;Content-Type: application/json&quot;  -X GET  http://192.168.1.40:9200/students/_search?pretty  -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<p>多索引，多类型查询,一般格式为：<code>http://IP:port/&lt;indices1&gt;,&lt;indices2&gt;/&lt;type1&gt;,&lt;type2&gt;/_search?pretty</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.1.40:9200/_search?pretty  #  所有索引查询</span><br><span class="line">curl http://192.168.1.40:9200/students1,students2/_search?pretty</span><br></pre></td></tr></table></figure></p>
<p>mappping/analysis<br>ES对每一个文档会取得其所有域的所有值，生成一个名为”_all”的域，执行查询时，如果在query_string未指定查询的域，则在_all域上执行查询操作</p>
<p>不指定域查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl &apos;http://192.168.1.40:9200/students/_search?q=&quot;jing&quot;&amp;pretty&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 4,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 0.6931471,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.6931471,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;first_name&quot; : &quot;jing&quot;,</span><br><span class="line">          &quot;last_name&quot; : &quot;Huang&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>指定域精确查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl &apos;http://192.168.1.40:9200/students/_search?q=first_name:&quot;jing&quot;&amp;pretty&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 4,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 0.6931471,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.6931471,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;first_name&quot; : &quot;jing&quot;,</span><br><span class="line">          &quot;last_name&quot; : &quot;Huang&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看指定类型的mapping<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl http://192.168.1.40:9200/students/_mapping?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;students&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;first_name&quot; : &#123;    # 字段</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,   # 类型为文本</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;last_name&quot; : &#123;    # 字段</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,  # 类型为文本</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>request Body 请求查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -X GET   -H &quot;Content-Type: application/json&quot; http://192.168.1.40:9200/students/_search?pretty -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">   &quot;term&quot;: &#123;&quot;first_name&quot;:&quot;jing&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 3,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 0.6931471,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.6931471,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;first_name&quot; : &quot;jing&quot;,</span><br><span class="line">          &quot;last_name&quot; : &quot;Huang&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# curl -X GET   -H &quot;Content-Type: application/json&quot; http://192.168.1.40:9200/students/_search?pretty -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">   &quot;terms&quot;: &#123;&quot;first_name&quot;:[&quot;jing&quot;,&quot;xx&quot;,&quot;oo&quot;]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 3,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;students&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;class1&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;first_name&quot; : &quot;jing&quot;,</span><br><span class="line">          &quot;last_name&quot; : &quot;Huang&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>慢慢实践。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/09/15/log_elasticsearch_api/" data-id="cksr304c8003jbpjxrjrwfs2b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-log_elasticsearch-基本使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/15/log_elasticsearch-基本使用/" class="article-date">
  <time datetime="2019-08-15T02:42:36.000Z" itemprop="datePublished">2019-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/日志系统/">日志系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/15/log_elasticsearch-基本使用/">elasticsearch基本使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>官网：  <a href="https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-elastic-stack.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-elastic-stack.html</a>   </p>
<p>elasticsearch: 借住于LuceneAPI    重新封装实现的搜索组件，增加更强大的能力，将Lucene提供的索引组建成shar形式，分片后分布于各节点上从而构建成分布式时时查询组件。 是一个基Lucene实现的开源、分布式、RestFul的全文本搜索引擎，此外，它还是一个分布式实时文档存储，其中每个文档的每个field均是被索引的数据，且可被搜索，也是一个带实时分析功能的分布式搜索引擎，能够扩展至数以百计的节点实时处理PB级的数据</p>
<p>概念<br> 文档只有被索引后才能被索引，这个文档就放在一个叫索引的文件当中。<br> 在Lucene中每一项相当于MYsql表中一行数据，多个项在一起就组成了索引，但是每个索引会尽量存储同类型数据</p>
<p> 大索引的多个片分shard散到多个物理节点上去，可成完成读写负载均衡，分片节点挂了所有数据将丢失，但是分布式不应该这样，它还要通过主从副本实现分布解决单点故障问题。<br> 写操作会自动分配到主分片完成写操作，副本分片只有读权限</p>
<p>索引：  文档的集合，类似于表，索引名只能是小写字母<br>    类型(type): 类型是索引内部的逻辑分区，其意义完全取决于用户需求，一个索引内部可以定义一个或多个类型<br>                拥有相同域的文档的预定义，类似于表的表结构，文档是schema free模式自由,</p>
<pre><code>建议一个索引中只存一个类型的文档数据
文档： 是Lucene搜索和索引的原子单位，包含了一个或多个域，是域容器，基于json格式，每个域的组成部份：一个名字和一个或多个值，拥有多个值的域通常称为多值域


映射 (maping):  定义如何切词，指明一个文档中的数据在被存储之前的分析过程该如何执行，原始内容存储为文档之前事先需要分析，映射就 是定义此分析机制该如何实现
                 例如; 切词、过滤掉某些词、域中内容排序

elasticsearch集群组件：
     每一个物理节点必属于且只属于某ES集群   

    NODE： 运行了单个ES实例的主机即为节点，用于存储数据部份分片、参与集群索引及搜索操作、节点标识靠节点名（默认会生成字串，可自定义）

    shard分片: 把一个Luence大索引切分为底层物理数据，完成分割存储机制，或说将索引切割成为物理存储组件，但每一个shard都是一个独立且完整的索引，创建索引时，ES默认创建5个副本
               shard有2种类型： primary shard/Replicas shard
               Primary shard 如何切割定义好后不可更改，但是副本数是可以动态更改的
</code></pre><p>ES工作过程： 通过多播(default)或单播方式工作在9300/TCP查找同一集群的其它节点，并与之建立通信                   </p>
<p>集群中的所有节点会选举一个主节点负责管理整个集群状态，以及在集群范围内决定各shard分布方式，用户角度没有主从节点，各节点都可接收请求</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>elasticsearch强制要求工作在普通用户模式下，不能root 直接./bin/elasticsearch启动服务，好像rpm安装没有此限制<br>同时启动也有很多限制，否则启动失败</p>
<p>修改系统参数达到启动服务要求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 普通用户模式下安装</span><br><span class="line">2 安装jdk,要求1.8以上，有人声称1.11以上更佳</span><br><span class="line">3 打开文件数限制，包括系统级/etc/security/limits.conf 和ulimit -n 65535用户级</span><br><span class="line">4 打开内核参数级限制,临时设置如下命令</span><br><span class="line">sysctl -w  vm.max_map_count=655350</span><br><span class="line">sysctl -w  fs.file-max=65536</span><br></pre></td></tr></table></figure></p>
<p>配置文件修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /home/stack/elasticsearch-7.11.2/config/elasticsearch.yml  | grep -v ^# | grep -v ^$</span><br><span class="line">cluster.name: wxq-es</span><br><span class="line">node.name: node-es3</span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">network.host: 192.168.1.30</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.1.30&quot;,]  # 集群模式相应追加主机</span><br><span class="line">cluster.initial_master_nodes: [&quot;192.168.1.30&quot;,]</span><br><span class="line">http.cors.enabled: true   # 方便plugins head插件时跨站请求成功</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure></p>
<p>head 插件安装<br>安装好后直接访问 <a href="http://IP:9100/" target="_blank" rel="noopener">http://IP:9100/</a>    连接地址填入<a href="http://es-server:9200/正确" target="_blank" rel="noopener">http://es-server:9200/正确</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line">cd elasticsearch-head</span><br><span class="line">npm install</span><br><span class="line">npm run start</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch # 直接启动即可</span><br></pre></td></tr></table></figure>
<p>集群状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">green 可用状态</span><br><span class="line">red:  不可用</span><br><span class="line">yellow: 修复状态</span><br><span class="line"></span><br><span class="line">ES参与集群事务的端口tcp/9300</span><br><span class="line">ES接收请求的端口tcp/9200</span><br></pre></td></tr></table></figure>
<p>API接口使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">确保集群正常； API接口9200</span><br><span class="line">Restful接口API： 4类</span><br><span class="line">1 检查集群节点索引健康与否，以及获取其相应状态</span><br><span class="line">2 管理集群节点索引及元数据</span><br><span class="line">3 执行CRUD操作</span><br><span class="line">4 执行高级操作：例如paging 、filtering</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">所有_cat支持的API操作</span><br><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cat</span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">。。。</span><br></pre></td></tr></table></figure>
<p>v=verbose显示详细信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.30:9200/_cat/nodes</span><br><span class="line">http://192.168.1.30:9200/_cat/nodes?v</span><br><span class="line">http://192.168.1.30:9200/_cat/master</span><br><span class="line">http://192.168.1.30:9200/_cat/master?v</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cat/nodes?v</span><br><span class="line">ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name</span><br><span class="line">172.21.0.5           36          98  14    0.22    0.60     1.09 cdfhilmrstw -      es02</span><br><span class="line">172.21.0.3           28          98  14    0.22    0.60     1.09 cdfhilmrstw *      es01</span><br><span class="line">172.21.0.4           61          98  14    0.22    0.60     1.09 cdfhilmrstw -      es03</span><br></pre></td></tr></table></figure></p>
<p>help查看某接口支持查询的详细字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# curl  http://192.168.1.40:9200/_cat/nodes?help</span><br><span class="line">id                             | id,nodeId                 | unique node id</span><br><span class="line">pid                            | p                         | process id</span><br><span class="line">ip                             | i                         | ip address</span><br><span class="line">port                           | po                        | bound transport port</span><br><span class="line">http_address                   | http                      | bound http address</span><br><span class="line">version                        | v                         | es version</span><br><span class="line">。。。</span><br></pre></td></tr></table></figure></p>
<p>查询某接口指定字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># curl  http://192.168.1.40:9200/_cat/nodes?h=id,pid,ip,port,http_address,version,uptime</span><br><span class="line">t_iA 6 172.21.0.5 9300 172.21.0.5:9200 7.12.0 56.8m</span><br><span class="line">WIm1 6 172.21.0.3 9300 172.21.0.3:9200 7.12.0 56.8m</span><br><span class="line">3bzJ 6 172.21.0.4 9300 172.21.0.4:9200 7.12.0 56.8m</span><br></pre></td></tr></table></figure></p>
<p>health的green状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># curl  http://192.168.1.40:9200/_cat/health?v</span><br><span class="line">epoch      timestamp cluster           status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1618470428 07:07:08  es-docker-cluster green           3         3     14   7    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>带着概念参照官网安装还是挺简单的，练习接口可以了解学习集群及ES的概念</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/08/15/log_elasticsearch-基本使用/" data-id="cksr304c6003hbpjxeuay0an4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-mysql-data-recovery" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/25/mysql-data-recovery/" class="article-date">
  <time datetime="2019-07-25T01:41:54.000Z" itemprop="datePublished">2019-07-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Mysql/">Mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/25/mysql-data-recovery/">mariadb-恢复数据</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/07/25/mysql-data-recovery/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/07/25/mysql-data-recovery/" data-id="cksr304cn004abpjxr7572aiu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-log_lucene-认识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/15/log_lucene-认识/" class="article-date">
  <time datetime="2019-06-15T02:42:36.000Z" itemprop="datePublished">2019-06-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/日志系统/">日志系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/15/log_lucene-认识/">搜索引擎与Lucene基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> 简单常识：<br>1千万条日志记录存储大小为2G<br>1亿条日志记录  5G<br>8亿条日志记录  40G</p>
<p>程序： 算法+数据结构<br>存储+前端访问接口</p>
<p>开发全文搜索程序： 算法+支持这种场景的特定存储结构<br>海量日志分析： 搜索引擎<br>搜索引擎： 存储时需要有索引链–&gt; 搜索组件（有请求接口有请求返回或展示UI）</p>
<p>收集日志 –&gt; 对收集过来日志检索原始内容–&gt; 构建文档 –&gt;文档分析或切词  –&gt; 建立索引链（创建倒排索引）<br>而SQL的索引： 正排索引</p>
<p>文档数据库： Mongodb、elasticsearch(每一行中每字段文档数据格式各不一样)</p>
<p>著名开源搜索开发库或底层搜索引擎: Lucene<br>添加收集文档，搜索引擎，提供上层搜索接口：  Elasticsearch </p>
<p>包含一个或多个域的容器，文档就是由Field、Value组成<br>Lucene没有全局模式：no schema,没有预先定义字段及类型<br>域有很多选项： 索引选项、存储选项、每个域向量使用选项<br>索引选项用于通过倒排索来控制文本是否可被搜索，成为索引中的项才能被搜索：<br>      index:  ANALYZIED 需要分析或分词并单独构建索引项<br>      index:  not_ANALYZIED  不分析或不分词，把整个内容当一个索引项<br>      index:  analyzied norms 类似index:  ANALYZIED，不会在存储中存储加权信息(Norms:加权基准)<br>      index.Not_analyzied_norms 类似not_ANALYZIED，不会在存储中存储加权信息(Norms:加权基准)<br>      index.NO : 不对此域的值进行索引，因此不能被搜索<br>存储选项: 是否需要存储域的真实值<br> title:  This is a Notebook.  –&gt; this notebook 有效信息即可<br>   store.YES: 存储真实值<br>   store.NO:   不存储真实值 </p>
<p>(每个项或每个域)向量选项用于在搜索期间控制该文档所有的唯一项都能完全从文档域中检索时使用</p>
<p>文档和域的加权操作： 通过改变某一个文档相对于某一个词的加权因子，对值改大改小可以决定它对用户的重要程序，如竟价排名<br>    加权计算标准：方案很多</p>
<p>搜索：查询Lucene索引时，返回一个有序的scoreDoc对象：<br>查询时Lucene会为每个文档计算出score,<br>API: IndexSearcher: 搜索索引入口<br>      Query及其子类：构建搜索查询语句<br>      QueryParser: 搜索分析后返回结果<br>      TopDocs 某查询分值top10</p>
<p>Lucene的多样化查询：<br>    IndexSearcher中的search方法，完成搜索时传入Query实例参数进行，就是告之到底要搜索什么，你键入的搜索关键词分析以后作为Query对象，传递给IndexSearch方法</p>
<p>常用几种查询方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TermQuery： 对索引中特定项进行搜索，Term是索引中的最小索引片段，每个Term包含一个域名和文本值</span><br><span class="line"></span><br><span class="line">title: This is a Desk</span><br><span class="line">title: Tis is a table</span><br><span class="line">索引构建方式：     This： （1） (2)</span><br><span class="line">                   Desk：  (1)</span><br><span class="line">				   table:  (2)</span><br><span class="line">				   </span><br><span class="line"> TermRangeQuery:索引中每个Term对象上的值都会按照字典编排顺序进行排序，并允许在Lucene TermRangeQuery 提供的范围内进行搜索</span><br><span class="line">                大白话就是TermQuery指定一个域中搜索，TermRangeQuery可以指定多个域内搜索</span><br><span class="line">			  </span><br><span class="line"> NumericRangeQuery： 只是数值范围内搜索</span><br><span class="line"> PrefixQuery： 用于搜索以指定字符串开头的域</span><br><span class="line"> BooleanQuery：用于实现组合查询，与或非  and 、or、 not</span><br><span class="line"> PhraseQuery： 能够跟据位置信息定义文档</span><br><span class="line">    WildcardQuery：通配符</span><br><span class="line">    FuzzyQuery：  模糊查询	</span><br><span class="line">    levenshtein处理</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Lucene是底层搜索引擎或搜索开发库，基于Lucene库开发有了Elasticsearch存储、搜索引擎系统</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/06/15/log_lucene-认识/" data-id="cksr304cd003qbpjxehcvz7wr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-Kubernetes-dashboard-TLS坑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/11/Kubernetes-dashboard-TLS坑/" class="article-date">
  <time datetime="2019-06-11T12:51:41.000Z" itemprop="datePublished">2019-06-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器世界/">容器世界</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/11/Kubernetes-dashboard-TLS坑/">kubernetes-dashboard-TLS坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/06/11/Kubernetes-dashboard-TLS坑/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/06/11/Kubernetes-dashboard-TLS坑/" data-id="cksr3049k0003bpjx388sz66n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-python-Celery-Flask" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/10/python-Celery-Flask/" class="article-date">
  <time datetime="2019-02-10T09:03:01.000Z" itemprop="datePublished">2019-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/10/python-Celery-Flask/">python-celery-Flask</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、基本使用"><a href="#一、基本使用" class="headerlink" title="一、基本使用"></a>一、基本使用</h3><p>Celery是由Python开发的一个简单、灵活、可靠的处理大量任务的分发系统，可以实时处理任务，也可以定时异步处理任务。<br>每次分发任务后得到一个ID，然后根据这个ID查询任务执行情况。</p>
<p>并且celery需要rabbitMQ、Redis等充当broker来进行消息的接收。</p>
<p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install celery eventlet   # windows系统需要eventlet模块</span><br></pre></td></tr></table></figure></p>
<p>下面我们来快速上手celery<br>编辑s1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery import Celery</span><br><span class="line"></span><br><span class="line">cel = Celery(&apos;xxx&apos;,</span><br><span class="line">             broker=&quot;redis://192.168.1.40&quot;,</span><br><span class="line">             backend=&apos;redis://192.168.1.40&apos;)</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def f1(x,y):</span><br><span class="line">    return x+y</span><br></pre></td></tr></table></figure></p>
<p>然后把s1这个work工作起来，进入命令终端,如果在linux系统，不用添加参数-P eventlet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A s1 -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<p>编辑s2.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import datetime</span><br><span class="line">from s1 import f1</span><br><span class="line"></span><br><span class="line"># 立即执行</span><br><span class="line">result = f1.delay(4,6)</span><br><span class="line">print(result.id)</span><br><span class="line"></span><br><span class="line"># 定时执行</span><br><span class="line">ctime = datetime.datetime.now()</span><br><span class="line"># ctime = datetime.datetime(year=2019,month=2,day=21,hour=14,minute=8)</span><br><span class="line">utc_time = datetime.datetime.utcfromtimestamp(ctime.timestamp())</span><br><span class="line">s10 = datetime.timedelta(seconds=10)</span><br><span class="line">ctime_x = utc_time + s10</span><br><span class="line">result = f1.apply_async(args=[1,3],eta=ctime_x)</span><br><span class="line">print(result.id)</span><br></pre></td></tr></table></figure></p>
<p>编辑s3.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery.result import  AsyncResult</span><br><span class="line">from demo1.s1 import cel</span><br><span class="line"></span><br><span class="line">async = AsyncResult(id=&quot;f43bce52-9503-475e-9d19-4a46ed910a8e&quot;,app=cel)</span><br><span class="line"></span><br><span class="line">if async.successful():</span><br><span class="line">    ret = async.get() # 获取值</span><br><span class="line">    #async.forget()  #  删除值</span><br><span class="line">    print(ret)</span><br><span class="line">elif async.failed():</span><br><span class="line">    print(&apos;执行失败&apos;)</span><br><span class="line">elif async.status == &apos;PENDING&apos;:</span><br><span class="line">    print(&apos;任务等待中被执行&apos;)</span><br><span class="line">elif async.status == &apos;RETRY&apos;:</span><br><span class="line">    print(&apos;任务异常后正在重试&apos;)</span><br><span class="line">elif async.status == &apos;STARTED&apos;:</span><br><span class="line">    print(&apos;任务已经开始被执行&apos;)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;任务执行失败&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async.revoke()    #  取消一个任务，当一个任务正在执行，不能取消</span><br><span class="line">async.revoke(terminate=True)  # 终止一个任务，当一个任务正在执行，可以被终止</span><br></pre></td></tr></table></figure></p>
<h3 id="二、多目录结构"><a href="#二、多目录结构" class="headerlink" title="二、多目录结构"></a>二、多目录结构</h3><p>经过上面快速上手的学习，了解了celery的基本使用，那么重组一下代，形成项目中多目录结构看看相互之间如何调用？</p>
<p>创建一个celery_tasks的目录，里面一般保存2类文件，其中一个文件名称必须为celery,另一类就是定义task任务的文件，可以有多个。</p>
<p>定义celery_tasks/celery.py文件,如果有多个task任务文件，可以用includ列表包含进来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery import Celery</span><br><span class="line"># from celery.schedules import crontab</span><br><span class="line"></span><br><span class="line">cel = Celery(&apos;xxxxxx&apos;,</span><br><span class="line">                broker=&apos;redis://192.168.1.40:6379&apos;,</span><br><span class="line">                backend=&apos;redis://192.168.1.40:6379&apos;,</span><br><span class="line">                include=[&apos;celery_tasks.task1&apos;,)</span><br><span class="line">                #include=[&apos;celery_tasks.task1&apos;,&apos;celery_tasks.task2&apos;])</span><br><span class="line"></span><br><span class="line"># 时区</span><br><span class="line">cel.conf.timezone = &apos;Asia/Shanghai&apos;</span><br><span class="line"># 是否使用UTC</span><br><span class="line">cel.conf.enable_utc = False</span><br></pre></td></tr></table></figure></p>
<p>在多目录结构中，跑celery  work时不用指定到文件，指定目录即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A celery_tasks -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<p>定义celery_tasks/task1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from .celery import cel</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def f1(x,y):</span><br><span class="line">    return  x+y</span><br></pre></td></tr></table></figure></p>
<p>有了celery.py文件和task任务文件，我们就可以在任意地方调用任务了。</p>
<p>比如定义test/exec1.py文件来执行任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery_tasks.task1 import f1</span><br><span class="line"></span><br><span class="line">result = f1.delay(4,6)</span><br><span class="line">print(result.id)</span><br></pre></td></tr></table></figure></p>
<p>定义test/exec2.py文件来获取任务执行结果,需要提供任务ID<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery_tasks.celery import cel</span><br><span class="line">from celery.result import AsyncResult</span><br><span class="line"></span><br><span class="line">async = AsyncResult(id=&quot;be6bb021-da48-46a9-b1bc-94b987f7c8a7&quot;,app=cel)</span><br><span class="line"></span><br><span class="line">if async.successful():</span><br><span class="line">    print(async.get())</span><br><span class="line">else:</span><br><span class="line">    print(&quot;任务执行失败&quot;)</span><br></pre></td></tr></table></figure></p>
<h3 id="三、Flask中的例用"><a href="#三、Flask中的例用" class="headerlink" title="三、Flask中的例用"></a>三、Flask中的例用</h3><p>有了上面celery的认识，我们来简单写点代码，看一下在Flask框架中celery是如何使用的？</p>
<p>定义Flask项目启动文件app.py</p>
<p>写线上代码时是要把任务保存在数据库中的，这里仅作示例就保存在了HISTORY全局变量中了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from flask import Flask,request,render_template,redirect</span><br><span class="line"></span><br><span class="line">from celery_tasks.task2 import  deploy</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">HISTORY = []</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/index&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def index():</span><br><span class="line">    if  request.method == &quot;GET&quot;:</span><br><span class="line">        return render_template(&apos;index.html&apos;,history=HISTORY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/publish&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def publish():</span><br><span class="line">    if  request.method == &quot;GET&quot;:</span><br><span class="line">        return render_template(&apos;publish.html&apos;)</span><br><span class="line">    else:</span><br><span class="line">        version = request.form.get(&quot;version&quot;)</span><br><span class="line">        hosts = request.form.getlist(&quot;hosts&quot;)</span><br><span class="line">        print(version,hosts)</span><br><span class="line"></span><br><span class="line">        import datetime</span><br><span class="line">        ctime = datetime.datetime.now()</span><br><span class="line">        utc_time = datetime.datetime.utcfromtimestamp(ctime.timestamp())</span><br><span class="line">        ctime_10 = utc_time + datetime.timedelta(seconds=10)</span><br><span class="line">        result = deploy.apply_async(args=[version,hosts],eta=ctime_10)</span><br><span class="line">        HISTORY.append(&#123;&quot;version&quot;:version,&quot;hosts&quot;:hosts,&quot;task_id&quot;:result.id&#125;)</span><br><span class="line">        print(HISTORY)</span><br><span class="line">        return redirect(&quot;/index&quot;)</span><br><span class="line"></span><br><span class="line">from celery.result import AsyncResult</span><br><span class="line">from celery_tasks.celery import cel</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/check_result&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def check_result():</span><br><span class="line">    task_id = request.args.get(&quot;task_id&quot;)</span><br><span class="line">    async = AsyncResult(id=task_id,app=cel)</span><br><span class="line">    if async.successful():</span><br><span class="line">        result = async.get()</span><br><span class="line">        print(result)</span><br><span class="line">        # result.forget() # 将结果删除</span><br><span class="line">        return &quot;执行成功&quot;</span><br><span class="line">    elif async.failed():</span><br><span class="line">        return &apos;执行失败&apos;</span><br><span class="line">    elif async.status == &apos;PENDING&apos;:</span><br><span class="line">        return &apos;任务等待中被执行&apos;</span><br><span class="line">    elif async.status == &apos;RETRY&apos;:</span><br><span class="line">        return &apos;任务异常后正在重试&apos;</span><br><span class="line">    elif async.status == &apos;STARTED&apos;:</span><br><span class="line">        return &apos;任务已经开始被执行&apos;</span><br><span class="line">    else:</span><br><span class="line">        return &quot;unkown status&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/cancel&apos;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span><br><span class="line">def cancel():</span><br><span class="line">    task_id = request.args.get(&quot;task_id&quot;)</span><br><span class="line">    async =AsyncResult(id=task_id,app=cel)</span><br><span class="line">    async.revoke(terminate=True)</span><br><span class="line">    for i in HISTORY:</span><br><span class="line">        if task_id in i.values():</span><br><span class="line">            HISTORY.remove(i)</span><br><span class="line">    return redirect(&quot;/index&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>定义其中用到的templates/index.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;发布系统&lt;/h1&gt;</span><br><span class="line">&lt;a href=&quot;/publish&quot;&gt;添加发布任务&lt;/a&gt;</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &#123;% for row in history %&#125;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; row.task_id &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; row.version &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &#123;% for host in  row.hosts %&#125;</span><br><span class="line">           &lt;td&gt;</span><br><span class="line">              &lt;span&gt;&#123;&#123; host &#125;&#125;&lt;/span&gt;</span><br><span class="line">           &lt;/td&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &lt;td&gt;&lt;a href=&quot;/check_result?task_id=&#123;&#123; row.task_id &#125;&#125;&quot;&gt;查看&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&lt;a href=&quot;/cancel?task_id=&#123;&#123; row.task_id &#125;&#125;&quot;&gt;取消&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>定义其中用到的templates/publish.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;version&quot; placeholder=&quot;请输入要发布的版本&quot;&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;select name=&quot;hosts&quot; multiple=&quot;multiple&quot;&gt;</span><br><span class="line">            &lt;option value=&quot;c1.com&quot;&gt;c1.com&lt;/option&gt;</span><br><span class="line">            &lt;option value=&quot;c2.com&quot;&gt;c2.com&lt;/option&gt;</span><br><span class="line">            &lt;option value=&quot;c3.com&quot;&gt;c3.com&lt;/option&gt;</span><br><span class="line">        &lt;/select&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>定义其中的celery_tasks.task2.py文件,这里的deploy是真正定义任务的地方.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from .celery import cel</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def deploy(version,hosts):</span><br><span class="line">    print(version, hosts) # 定义想要执行的任务代码</span><br><span class="line">    return &apos;deploy ok&apos;</span><br></pre></td></tr></table></figure></p>
<p>同样别望了先把work跑起来,再启动Flask<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A celery_tasks -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>还需要多写代码在项目中总结celery…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/02/10/python-Celery-Flask/" data-id="cksr304dj005ubpjxv0te0rzn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-ansible-Callback-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/12/ansible-Callback-02/" class="article-date">
  <time datetime="2019-01-12T12:39:12.000Z" itemprop="datePublished">2019-01-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/12/ansible-Callback-02/">ansible callback 重写</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-adhoc-callback重写"><a href="#1-1-adhoc-callback重写" class="headerlink" title="1.1 adhoc callback重写"></a>1.1 adhoc callback重写</h3><p>adhoc-callback.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line">#^#Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line">#^# 执行对象和模块</span><br><span class="line">play_data = dict(</span><br><span class="line">    name=&quot;Ansible adhoc example&quot;,</span><br><span class="line">    hosts=&apos;192.168.1.6,&apos;,</span><br><span class="line">    gather_facts=&apos;no&apos;,</span><br><span class="line">    tasks=[</span><br><span class="line">        dict(action=dict(module=&apos;shell&apos;, args=&quot;touch /tmp/sss.txt&quot;)),</span><br><span class="line">        # dict(action=dict(module=&apos;debug&apos;, args=dict(msg=&quot;&#123;&#123;  shell_out.stdout  &#125;&#125;&quot;))),</span><br><span class="line">     ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">play = Play().load(data=play_data,loader=loader,variable_manager=varmanager)</span><br><span class="line"></span><br><span class="line">#^# 重写CallbackBase父类</span><br><span class="line">class AdhocResultsCollector(CallbackBase):</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(AdhocResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.host_ok = &#123;&#125;</span><br><span class="line">        self.host_unreachable = &#123;&#125;</span><br><span class="line">        self.host_failed = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_unreachable(self, result):</span><br><span class="line">        self.host_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_ok(self, result,  *args, **kwargs):</span><br><span class="line">        self.host_ok[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_failed(self, result,  *args, **kwargs):</span><br><span class="line">        self.host_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">callback = AdhocResultsCollector()</span><br><span class="line">passwords = dict()</span><br><span class="line">tqm = TaskQueueManager(inventory=myinven,</span><br><span class="line">                       variable_manager=varmanager,</span><br><span class="line">                       loader=loader,options=options,</span><br><span class="line">                       passwords=passwords,</span><br><span class="line">                       stdout_callback=callback</span><br><span class="line">                       )</span><br><span class="line"></span><br><span class="line">result_status_code = tqm.run(play)</span><br><span class="line"></span><br><span class="line">print(callback.host_ok.items())</span><br><span class="line"></span><br><span class="line">result_raw = dict(</span><br><span class="line">    success = &#123;&#125;,</span><br><span class="line">    failed = &#123;&#125;,</span><br><span class="line">    unreachable = &#123;&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_ok.items():</span><br><span class="line">    result_raw[&apos;success&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_failed.items():</span><br><span class="line">    result_raw[&apos;failed&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_unreachable.items():</span><br><span class="line">    result_raw[&apos;unreachable&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">print(json.dumps(result_raw,indent=4))</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-playbook-callback重写"><a href="#1-2-playbook-callback重写" class="headerlink" title="1.2 playbook callback重写"></a>1.2 playbook callback重写</h3><p>写入示例playbook文件site.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: 192.168.1.6</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    touch_file: &quot;site.txt&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch file</span><br><span class="line">      shell: &quot;touch /tmp/&#123;&#123;  touch_file &#125;&#125;&quot;</span><br></pre></td></tr></table></figure></p>
<p>编写play_book.py 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                                &apos;connection&apos;,</span><br><span class="line">                                &apos;module_path&apos;,</span><br><span class="line">                                &apos;forks&apos;,</span><br><span class="line">                                &apos;timeout&apos;,</span><br><span class="line">                                &apos;remote_user&apos;,</span><br><span class="line">                                &apos;ask_pass&apos;,</span><br><span class="line">                                &apos;private_key_file&apos;,</span><br><span class="line">                                &apos;ssh_common_args&apos;,</span><br><span class="line">                                &apos;ssh_extra_args&apos;,</span><br><span class="line">                                &apos;sftp_extra_args&apos;,</span><br><span class="line">                                &apos;scp_extra_args&apos;,</span><br><span class="line">                                &apos;become&apos;,</span><br><span class="line">                                &apos;become_method&apos;,</span><br><span class="line">                                &apos;become_user&apos;,</span><br><span class="line">                                &apos;ask_value_pass&apos;,</span><br><span class="line">                                &apos;verbosity&apos;,</span><br><span class="line">                                &apos;check&apos;,</span><br><span class="line">                                &apos;listhosts&apos;,</span><br><span class="line">                                &apos;listtasks&apos;,</span><br><span class="line">                                &apos;listtags&apos;,</span><br><span class="line">                                &apos;syntax&apos;,</span><br><span class="line">                                &apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;,</span><br><span class="line">                  module_path=None,</span><br><span class="line">                  forks=100,</span><br><span class="line">                  timeout=10,</span><br><span class="line">                  remote_user=&apos;root&apos;,</span><br><span class="line">                  ask_pass=False,</span><br><span class="line">                  private_key_file=None,</span><br><span class="line">                  ssh_common_args=None,</span><br><span class="line">                  ssh_extra_args=None,</span><br><span class="line">                  sftp_extra_args=None,</span><br><span class="line">                  scp_extra_args=None,</span><br><span class="line">                  become=None,</span><br><span class="line">                  become_method=None,</span><br><span class="line">                  become_user=&apos;root&apos;,</span><br><span class="line">                  ask_value_pass=False,</span><br><span class="line">                  verbosity=None,</span><br><span class="line">                  check=False,</span><br><span class="line">                  listhosts=False,</span><br><span class="line">                  listtasks=False,</span><br><span class="line">                  listtags=False,</span><br><span class="line">                  syntax=False,</span><br><span class="line">                  diff=True,</span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line"># 重写CallbackBase父类</span><br><span class="line">class PlayBookResultsCollector(CallbackBase):</span><br><span class="line">    CALLBACK_VERSION = 2.0</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(PlayBookResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.task_ok = &#123;&#125;</span><br><span class="line">        self.task_skipped = &#123;&#125;</span><br><span class="line">        self.task_failed = &#123;&#125;</span><br><span class="line">        self.task_status = &#123;&#125;</span><br><span class="line">        self.task_unreachable = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_ok(self, result, *args, **kwargs):</span><br><span class="line">        self.task_ok[result._host.get_name()]  = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_failed(self, result, *args, **kwargs):</span><br><span class="line">        self.task_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_unreachable(self, result):</span><br><span class="line">        self.task_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_skipped(self, result):</span><br><span class="line">        self.task_ok[result._host.get_name()]  = result</span><br><span class="line"></span><br><span class="line">    def v2_playbook_on_stats(self, stats):</span><br><span class="line">        hosts = sorted(stats.processed.keys())</span><br><span class="line">        for h in hosts:</span><br><span class="line">            t = stats.summarize(h)</span><br><span class="line">            self.task_status[h] = &#123;</span><br><span class="line">                                       &quot;ok&quot;:t[&apos;ok&apos;],</span><br><span class="line">                                       &quot;changed&quot; : t[&apos;changed&apos;],</span><br><span class="line">                                       &quot;unreachable&quot;:t[&apos;unreachable&apos;],</span><br><span class="line">                                       &quot;skipped&quot;:t[&apos;skipped&apos;],</span><br><span class="line">                                       &quot;failed&quot;:t[&apos;failures&apos;]</span><br><span class="line">                                   &#125;</span><br><span class="line"># 执行对象和模块</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">#传入playbooks, inventory, variable_manager, loader, options, passwords</span><br><span class="line">playbook = PlaybookExecutor(playbooks=[&apos;site.yml&apos;,],</span><br><span class="line">                            inventory=myinven,</span><br><span class="line">                            variable_manager=varmanager,</span><br><span class="line">                            loader=loader,</span><br><span class="line">                            options=options,</span><br><span class="line">                            passwords=passwords</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line"># 把重写的CallbackBase父类加载进playbook</span><br><span class="line">callback = PlayBookResultsCollector()</span><br><span class="line">playbook._tqm._stdout_callback = callback</span><br><span class="line">playbook.run()</span><br><span class="line"></span><br><span class="line">result_raw = dict(</span><br><span class="line">    success = &#123;&#125;,</span><br><span class="line">    failed = &#123;&#125;,</span><br><span class="line">    unreachable = &#123;&#125;,</span><br><span class="line">    skipped = &#123;&#125;,</span><br><span class="line">    status = &#123;&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_ok.items():</span><br><span class="line">    result_raw[&apos;success&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_failed.items():</span><br><span class="line">    result_raw[&apos;failed&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_unreachable.items():</span><br><span class="line">    result_raw[&apos;unreachable&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_skipped.items():</span><br><span class="line">    result_raw[&apos;skipped&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host, result in callback.task_status.items():</span><br><span class="line">    result_raw[&apos;status&apos;][host] = result</span><br><span class="line"></span><br><span class="line">print(json.dumps(result_raw,indent=4))</span><br></pre></td></tr></table></figure></p>
<p>执行示例<br>python3 play_book.py 返回类似如下结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;success&quot;: &#123;</span><br><span class="line">        &quot;192.168.1.6&quot;: &#123;</span><br><span class="line">            &quot;changed&quot;: true,</span><br><span class="line">            &quot;end&quot;: &quot;2019-01-14 04:50:06.190607&quot;,</span><br><span class="line">            &quot;stdout&quot;: &quot;&quot;,</span><br><span class="line">            &quot;cmd&quot;: &quot;touch /tmp/site.txt&quot;,</span><br><span class="line">            &quot;rc&quot;: 0,</span><br><span class="line">            &quot;start&quot;: &quot;2019-01-14 04:50:06.186466&quot;,</span><br><span class="line">            &quot;stderr&quot;: &quot;&quot;,</span><br><span class="line">            &quot;delta&quot;: &quot;0:00:00.004141&quot;,</span><br><span class="line">            &quot;invocation&quot;: &#123;</span><br><span class="line">                &quot;module_args&quot;: &#123;</span><br><span class="line">                    &quot;creates&quot;: null,</span><br><span class="line">                    &quot;executable&quot;: null,</span><br><span class="line">                    &quot;_uses_shell&quot;: true,</span><br><span class="line">                    ... 略</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;failed&quot;: &#123;&#125;,</span><br><span class="line">    &quot;unreachable&quot;: &#123;&#125;,</span><br><span class="line">    &quot;skipped&quot;: &#123;&#125;,</span><br><span class="line">    &quot;status&quot;: &#123;</span><br><span class="line">        &quot;192.168.1.6&quot;: &#123;</span><br><span class="line">            &quot;ok&quot;: 2,</span><br><span class="line">            &quot;changed&quot;: 1,</span><br><span class="line">            &quot;unreachable&quot;: 0,</span><br><span class="line">            &quot;skipped&quot;: 0,</span><br><span class="line">            &quot;failed&quot;: 0</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>adhoc重写方法如host_ok,host_failed,host_unreachable</li>
<li>playbook重写方法如task_ok,task_failed,task_unreachable,task_skipped,task_status,task_changed</li>
<li>返回如callback.task_ok.items(),其中键为host,值为result对象，result._result得到一个字典类型的详细结果</li>
</ul>
<p>&lt;&lt; 完结 &gt;&gt;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/12/ansible-Callback-02/" data-id="cksr304a5000kbpjxt53ptzah" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-ansible-api-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/10/ansible-api-01/" class="article-date">
  <time datetime="2019-01-10T12:39:12.000Z" itemprop="datePublished">2019-01-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/10/ansible-api-01/">python3下ansible api学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-ansible-api基础"><a href="#1-1-ansible-api基础" class="headerlink" title="1.1 ansible api基础"></a>1.1 ansible api基础</h3><p>环境说明：</p>
<ul>
<li>python version: python3</li>
<li>ansible version:  2.7.5</li>
<li>inventory file:  dir1/inventory/multinode</li>
</ul>
<p>清单文件定义：  dir1/inventory/multinode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[control]</span><br><span class="line">192.168.1.6 var1=&quot;ssss&quot;  ansible_ssh_user=root ansible_ssh_pass=&apos;123&apos;</span><br><span class="line"></span><br><span class="line">[nova:children]</span><br><span class="line">control</span><br><span class="line"></span><br><span class="line">[cinder:children]</span><br><span class="line">control</span><br><span class="line"></span><br><span class="line">[glance:children]</span><br></pre></td></tr></table></figure></p>
<p>一个单一文件进行简单的接口学习:  dir1/f1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import os,sys,json</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import   VariableManager</span><br><span class="line">from ansible.inventory.manager import InventoryManager</span><br><span class="line">from ansible.playbook  import play</span><br><span class="line">from ansible.executor.task_queue_manager import TaskQueueManager</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">import ansible.constants as C</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&quot;dir1/inventory/multinode&quot;)</span><br><span class="line">loader  = DataLoader()</span><br><span class="line">inven = InventoryManager(loader=loader,sources=[source,])</span><br><span class="line"># print(inven.get_hosts())</span><br><span class="line"></span><br><span class="line">inven.add_group(&apos;test_group2&apos;)</span><br><span class="line">print(inven.get_groups_dict())</span><br><span class="line">inven.add_host(host=&apos;192.168.1.7&apos;,port=22,group=&apos;test_group2&apos;)</span><br><span class="line">print(inven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">host = inven.get_host(hostname=&apos;192.168.1.6&apos;)</span><br><span class="line"></span><br><span class="line">variableman = VariableManager(loader=loader,inventory=inven)</span><br><span class="line">vars = variableman.get_vars(host=host)</span><br><span class="line"></span><br><span class="line"># print(json.dumps(vars,indent=4))</span><br><span class="line">variableman.set_host_variable(host=host,varname=&apos;k1&apos;,value=&apos;v1&apos;)   # 局部的</span><br><span class="line"></span><br><span class="line">x = variableman.get_vars(host=host)</span><br><span class="line">print(x[&apos;k1&apos;])</span><br><span class="line">print(variableman.__dict__)</span><br><span class="line">variableman._extra_vars = &#123;&quot;k2&quot;: &quot;v2&quot;&#125;     # 添加全局变量</span><br><span class="line"></span><br><span class="line">x = variableman.get_vars()  # 不传host说明是全局的</span><br></pre></td></tr></table></figure></p>
<p>执行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3  dir1/f1.py   # 输出调用信息对照接口就知道只些方法是干什么的了</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-adhoc模式示例学习"><a href="#1-2-adhoc模式示例学习" class="headerlink" title="1.2 adhoc模式示例学习"></a>1.2 adhoc模式示例学习</h3><p>编辑dir1/adhoc.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line"># 执行对象和模块</span><br><span class="line">play_data = dict(</span><br><span class="line">    name=&quot;Ansible adhoc example&quot;,</span><br><span class="line">    hosts=&apos;192.168.1.6,&apos;,</span><br><span class="line">    gather_facts=&apos;no&apos;,</span><br><span class="line">    tasks=[</span><br><span class="line">        dict(action=dict(module=&apos;shell&apos;, args=&quot;touch /tmp/sss.txt&quot;)),</span><br><span class="line">        # dict(action=dict(module=&apos;debug&apos;, args=dict(msg=&quot;&#123;&#123;  shell_out.stdout  &#125;&#125;&quot;))),</span><br><span class="line">     ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">play = Play().load(data=play_data,loader=loader,variable_manager=varmanager)</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">tqm = TaskQueueManager(inventory=myinven,variable_manager=varmanager, loader=loader,options=options,passwords=passwords)</span><br><span class="line"></span><br><span class="line">result = tqm.run(play)</span><br></pre></td></tr></table></figure></p>
<p>执行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3  dir1/adhoc.py</span><br></pre></td></tr></table></figure></p>
<p>输出信息和命令行ansible直接模块运行一样，任务正常执行</p>
<h3 id="1-3-playbook-示例学习"><a href="#1-3-playbook-示例学习" class="headerlink" title="1.3 playbook 示例学习"></a>1.3 playbook 示例学习</h3><p>编辑dir1/play_book.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line"># 执行对象和模块</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">#传入playbooks, inventory, variable_manager, loader, options, passwords</span><br><span class="line">playbook = PlaybookExecutor(playbooks=[&apos;site.yml&apos;,],</span><br><span class="line">                            inventory=myinven,</span><br><span class="line">                            variable_manager=varmanager,</span><br><span class="line">                            loader=loader,</span><br><span class="line">                            options=options,</span><br><span class="line">                            passwords=passwords)</span><br><span class="line">playbook.run()</span><br></pre></td></tr></table></figure></p>
<p>用到的site.yml文件示例如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: 192.168.1.6</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    touch_file: &quot;site.txt&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch file</span><br><span class="line">      shell: &quot;touch /tmp/&#123;&#123;  touch_file &#125;&#125;&quot;</span><br></pre></td></tr></table></figure></p>
<p>执行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 play_book.py</span><br></pre></td></tr></table></figure></p>
<p>输出信息和ansible-playbook命令行输出一样，任务正常执行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/10/ansible-api-01/" data-id="cksr304a7000mbpjxubxm49jm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-veth-pair+namespace" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/10/veth-pair+namespace/" class="article-date">
  <time datetime="2019-01-10T01:41:54.000Z" itemprop="datePublished">2019-01-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Openstack/">Openstack</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/10/veth-pair+namespace/">veth-pair+namespace</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>查找对端veth pair<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-m:/data/dashboard# cat /sys/class/net/cali3b4bae3cec1/iflink </span><br><span class="line">4</span><br><span class="line">root@k8s-m:/data/dashboard# ethtool  -S  cali3b4bae3cec1</span><br><span class="line">NIC statistics:</span><br><span class="line">     peer_ifindex: 4</span><br><span class="line">     rx_queue_0_xdp_packets: 0</span><br><span class="line">     rx_queue_0_xdp_bytes: 0</span><br><span class="line">     rx_queue_0_xdp_drops: 0</span><br></pre></td></tr></table></figure></p>
<p>namespace场景参考如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># ip link add veth-a type veth peer name veth-b    # 生成veth pair对，相当于一根网线</span><br><span class="line"># ip netns add ns1    #  创建名称空间</span><br><span class="line"># ip link set veth-a netns ns1  #将网线A端加入名称容间</span><br><span class="line">root@k8s-m:~# ip  netns exec ns1 ethtool -S veth-a   # veth-a的对端编号16</span><br><span class="line">NIC statistics:</span><br><span class="line">     peer_ifindex: 16</span><br><span class="line">     rx_queue_0_xdp_packets: 0</span><br><span class="line">     rx_queue_0_xdp_bytes: 0</span><br><span class="line">     rx_queue_0_xdp_drops: 0</span><br><span class="line">root@k8s-m:~# ip  netns exec ns1 cat /sys/class/net/veth-a/iflink    # veth-a的对端编号16</span><br><span class="line">16</span><br><span class="line"># ip a     #  查看编号16的设备</span><br><span class="line">16: veth-b@if17: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether be:ec:d2:fc:64:3f brd ff:ff:ff:ff:ff:ff link-netns ns1</span><br></pre></td></tr></table></figure></p>
<p>利用ovs实现跨主机通信的简单应用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-br ovs0</span><br><span class="line">ovs-vsctl add-port ovs0 eth0</span><br><span class="line">物理网卡加进ovs可能会断网，解决办法：</span><br><span class="line"># ifconfig ovs0 172.16.10.10/24</span><br><span class="line"># ifconfig eth0  0.0.0.0.0</span><br><span class="line"># route del default</span><br><span class="line"># route add default gw 172.16.10.254 dev ovs0</span><br><span class="line"># ifconfig ovs0 hw ether $eth0_mac</span><br></pre></td></tr></table></figure></p>
<p>注意： 完事后放在开机启动项，不然开机失效连不上机</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/10/veth-pair+namespace/" data-id="cksr304dt006dbpjx1n4w65kn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/6/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ceph/">Ceph</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mongodb/">Mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/">Openstack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Prometheus/">Prometheus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDjango开发/">WebDjango开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebFlask开发/">WebFlask开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebSocket/">WebSocket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web爬虫开发/">Web爬虫开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ansible/">ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/声明/">声明</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器世界/">容器世界</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志系统/">日志系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/12/15/linux-openssl-update/">升级openssl</a>
          </li>
        
          <li>
            <a href="/2021/10/15/linux-dd-fio/">磁盘性能测试</a>
          </li>
        
          <li>
            <a href="/2021/08/15/linux-lvm-migrate/">LVM 换盘</a>
          </li>
        
          <li>
            <a href="/2021/08/09/mysql-HA/">Mysql高可用集群</a>
          </li>
        
          <li>
            <a href="/2021/07/25/prometheus-relabel/">prometheus 重新打标</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 wxq<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<!--
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
-->

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>