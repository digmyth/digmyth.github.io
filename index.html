<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Welcome to wxq&#39;s Blog created in 2017-01-01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:url" content="http://www.digmyth.com/index.html">
<meta property="og:site_name" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
  
    <link rel="alternate" href="/atom.xml" title="Welcome to wxq&#39;s Blog created in 2017-01-01" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Welcome to wxq&#39;s Blog created in 2017-01-01</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.digmyth.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-nginx-upsync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/12/nginx-upsync/" class="article-date">
  <time datetime="2022-03-12T01:41:54.000Z" itemprop="datePublished">2022-03-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/12/nginx-upsync/">nginx upsync</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Nginx动态更新upstream</p>
<p>原理： 把upstream server注册到consul,nginx定时获取更新配置</p>
<p>安装consul<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://releases.hashicorp.com/consul/1.9.2/consul_1.9.2_linux_amd64.zip</span><br><span class="line">unzip  consul_1.9.2_linux_amd64.zip</span><br><span class="line">mv consul  /usr/local/sbin</span><br><span class="line">mkdir /consul/data</span><br><span class="line">mkdir /etc/consul</span><br><span class="line">consul agent -dev -ui --data-dir=/consul/data -config-dir=/etc/consul -client=0.0.0.0    # 启动consul</span><br></pre></td></tr></table></figure></p>
<p>界面访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://consulIP:5800/ui</span><br></pre></td></tr></table></figure></p>
<p>注册upstream server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># curl -X PUT -d  &apos;&#123;&quot;weight&quot;:1,&quot;max_fails&quot;:3,&quot;fail_timeout&quot;:20&#125;&apos;    127.0.0.1:8500/v1/kv/upstreams/appserver/192.168.1.203:8000</span><br></pre></td></tr></table></figure></p>
<p>编译nginx支持<code>nginx-upsync-module</code>模块<br>首先下载nginx-upsync-module源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/upsync  ;  git clone https://github.com/weibocom/nginx-upsync-module.git</span><br></pre></td></tr></table></figure></p>
<p>nginx编译参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure       --sbin-path=/usr/local/nginx/sbin/nginx      --conf-path=/usr/local/nginx/conf/nginx.conf      --pid-path=/usr/local/nginx/nginx.pid   --http-client-body-temp-path=/usr/local/nginx/client_body_temp  --http-proxy-temp-path=/usr/local/nginx/proxy_temp  --http-fastcgi-temp-path=/usr/local/nginx/fastcgi_temp  --http-uwsgi-temp-path=/usr/local/nginx/uwsgi_temp --http-scgi-temp-path=/usr/local/nginx/scgi_temp     --with-http_ssl_module  --with-http_stub_status_module --with-stream  --with-stream_ssl_preread_module --add-module=/opt/upsync/nginx-upsync-module/    ;    make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>nginx.conf配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  12;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream appserver &#123;</span><br><span class="line">        server 127.0.0.1:11111 down;   # 没卵用但必须要有</span><br><span class="line">        upsync 127.0.0.1:8500/v1/kv/upstreams/appserver/ upsync_timeout=6m upsync_interval=500ms upsync_type=consul strong_dependency=off;</span><br><span class="line">        upsync_dump_path /usr/local/nginx/conf/servers/upstream.conf;</span><br><span class="line"></span><br><span class="line">        include /usr/local/nginx/conf/servers/upstream.conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8001;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location  / &#123;</span><br><span class="line">            proxy_pass http://appserver;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动nginx服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line"> /usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure></p>
<p>查看同步过来的upstream server组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat /usr/local/nginx/conf/servers/upstream.conf</span><br><span class="line">server 192.168.1.203:8000 weight=1 max_fails=3 fail_timeout=20s;</span><br><span class="line">server 192.168.1.202:8000 weight=1 max_fails=9 fail_timeout=20s;</span><br></pre></td></tr></table></figure></p>
<p>移除某upstream server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE 127.0.0.1:8500/v1/kv/upstreams/test/192.168.1.203:8000</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>无</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2022/03/12/nginx-upsync/" data-id="cl1oueuuv005k0ojxoyc1r90f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-log_elk_version_8.1.1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/02/15/log_elk_version_8.1.1/" class="article-date">
  <time datetime="2022-02-15T02:12:36.000Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/日志系统/">日志系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/02/15/log_elk_version_8.1.1/">ELF8.1填坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2022/02/15/log_elk_version_8.1.1/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2022/02/15/log_elk_version_8.1.1/" data-id="cl1oueuu3004b0ojxj48b11sj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-gpu-01-初识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/02/15/gpu-01-初识/" class="article-date">
  <time datetime="2022-02-15T01:32:54.000Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GPU/">GPU</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/02/15/gpu-01-初识/">GPU</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>GeForce RTX 2080 Ti</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# lspci  -nn -k | grep -i nvidia</span><br><span class="line">02:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU102 [GeForce RTX 2080 Ti Rev. A] [10de:1e07] (rev a1)</span><br><span class="line">02:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:10f7] (rev a1)</span><br><span class="line">02:00.2 USB controller [0c03]: NVIDIA Corporation Device [10de:1ad6] (rev a1)</span><br><span class="line">02:00.3 Serial bus controller [0c80]: NVIDIA Corporation Device [10de:1ad7] (rev a1)</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.nvidia.cn/Download/index.aspx?lang=cn" target="_blank" rel="noopener">驱动下载</a><br>[2080 Ti直接下载(wget  <a href="https://cn.download.nvidia.com/XFree86/Linux-x86_64/510.60.02/NVIDIA-Linux-x86_64-510.60.02.run" target="_blank" rel="noopener">https://cn.download.nvidia.com/XFree86/Linux-x86_64/510.60.02/NVIDIA-Linux-x86_64-510.60.02.run</a>)<br>产品类型： GeForce<br>产品系列： GeForce RTX  20 Teries<br>产品家族： GeForce RTX  2080 Ti<br>操作系统：  Linux xx<br>下载类型： 生产分支生<br>语言：  Chinese （Simplified）</p>
<h3 id="安装驱动程序"><a href="#安装驱动程序" class="headerlink" title="安装驱动程序"></a>安装驱动程序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ISO]# ./NVIDIA-Linux-x86_64-510.60.02.run </span><br><span class="line">Verifying archive integrity... OK</span><br><span class="line">Uncompressing NVIDIA Accelerated Graphics Driver for Linux-x86_64 510.60.02....</span><br></pre></td></tr></table></figure>
<p>查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ISO]# nvidia-smi </span><br><span class="line">Sat Apr  2 17:08:34 2022       </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 510.60.02    Driver Version: 510.60.02    CUDA Version: 11.6     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  NVIDIA GeForce ...  Off  | 00000000:02:00.0 Off |                  N/A |</span><br><span class="line">| 22%   63C    P0    55W / 250W |      0MiB / 11264MiB |      0%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|  No running processes found                                                 |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>无</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2022/02/15/gpu-01-初识/" data-id="cl1oueupj001d0ojxpzcikmd1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-network-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/02/15/network-01/" class="article-date">
  <time datetime="2022-02-15T01:32:54.000Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/网络/">网络</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/02/15/network-01/">网络</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="vlan-应用"><a href="#vlan-应用" class="headerlink" title="vlan 应用"></a>vlan 应用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">安装包</span><br><span class="line">apt-get install vlan</span><br><span class="line"></span><br><span class="line">模块支持</span><br><span class="line">modprobe 8021q           //加载模块</span><br><span class="line">modprobe -r  8021q       //卸载模块</span><br><span class="line">echo &quot;8021q&quot; &gt;&gt; /etc/modules   //自动加载</span><br><span class="line"></span><br><span class="line">查看帮助</span><br><span class="line">vconfig -h </span><br><span class="line">man vconfig  更详细</span><br><span class="line"></span><br><span class="line">为网卡添加vlan设置（移除）</span><br><span class="line">vconfig  add eth3 100</span><br><span class="line">vconfig  add eth3 200</span><br><span class="line">vconfig  rem  eth3.200    （移除）</span><br><span class="line"></span><br><span class="line">查看所设置的参数</span><br><span class="line">cat /proc/net/vlan/eth0.100</span><br><span class="line"></span><br><span class="line">为vlan网卡设地址或写进网卡配置文件</span><br><span class="line">ifconfig eth0.100 192.168.1.100/24 up</span><br><span class="line">ifconfig eth0.200 192.168.1.200/24 up</span><br></pre></td></tr></table></figure>
<h3 id="ovs跨主机通信"><a href="#ovs跨主机通信" class="headerlink" title="ovs跨主机通信"></a>ovs跨主机通信</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">一个简单应用：</span><br><span class="line">ovs-vsctl add-br ovs0</span><br><span class="line">ovs-vsctl add-port ovs0 eth0</span><br><span class="line">物理网卡加进ovs可能会断网，解决办法：</span><br><span class="line">1 ifconfig ovs0 172.16.10.10/24</span><br><span class="line">2 ifconfig eth0  0.0.0.0.0</span><br><span class="line">3 route del default</span><br><span class="line">4 route add default gw 172.16.10.254 dev ovs0</span><br><span class="line">5 ifconfig ovs0 hw ether $eth0_mac</span><br><span class="line"></span><br><span class="line">示例：完事后放在开机启动项，不然开机失效联不上机</span><br></pre></td></tr></table></figure>
<h3 id="veth-pair查找"><a href="#veth-pair查找" class="headerlink" title="veth pair查找"></a>veth pair查找</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># ip link add veth-a type veth peer name veth-b    # 生成veth pair对，相当于一根网线</span><br><span class="line"># ip netns add ns1    #  创建名称空间</span><br><span class="line"># ip link set veth-a netns ns1  #将网线A端加入名称容间</span><br><span class="line">root@k8s-m:~# ip  netns exec ns1 ethtool -S veth-a   # veth-a的对端编号16</span><br><span class="line">NIC statistics:</span><br><span class="line">     peer_ifindex: 16</span><br><span class="line">     rx_queue_0_xdp_packets: 0</span><br><span class="line">     rx_queue_0_xdp_bytes: 0</span><br><span class="line">     rx_queue_0_xdp_drops: 0</span><br><span class="line">root@k8s-m:~# ip  netns exec ns1 cat /sys/class/net/veth-a/iflink    # veth-a的对端编号16</span><br><span class="line">16</span><br><span class="line"># ip a     #  查看编号16的设备</span><br><span class="line">16: veth-b@if17: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether be:ec:d2:fc:64:3f brd ff:ff:ff:ff:ff:ff link-netns ns1</span><br></pre></td></tr></table></figure>
<h3 id="ns名称空间"><a href="#ns名称空间" class="headerlink" title="ns名称空间"></a>ns名称空间</h3><p><a href="https://medium.com/@anilkreddyr/kubernetes-with-flannel-understanding-the-networking-part-2-78b53e5364c7" target="_blank" rel="noopener">参考学习链接</a></p>
<p>每创建一个容器都会生成名称空间，但是我们用ip netns却看不到名称空间，这是因为ip netns工作在/var/run/netns目录下，而docker产生的名称空间并不在这个目录下，所以看不到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ip netns add ns1</span><br><span class="line"># ip netns</span><br><span class="line"># ip netns exec ns1 ls -la /proc/self/ns</span><br></pre></td></tr></table></figure></p>
<h3 id="网桥工作模式"><a href="#网桥工作模式" class="headerlink" title="网桥工作模式"></a>网桥工作模式</h3><p>网桥可以工作于直接寄居于物理网卡之上，也可以工作于独立网桥模式(ip_forward模式),利用iptables规则SNAT转发对外通信，但是在k8s pod间通信中用的路由技术对外通信。</p>
<p>此处针对网桥工作于独立网桥模式(ip_forward模式)场景<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ip link add veth-a type veth peer name veth-b               //生成veth-pair</span><br><span class="line"># brctl addbr docker0									  //生成网桥</span><br><span class="line"># ifconfig docker0 172.17.1.254/24</span><br><span class="line"># brctl addif docker0 veth-b</span><br><span class="line"># ip link set veth-b up</span><br><span class="line"># ip netns add ns1</span><br><span class="line"># ip link set veth-a netns ns1</span><br><span class="line"># ip netns exec ns1 ip link set dev veth-a name eth0</span><br><span class="line"># ip netns exec ns1 ip link set eth0 up</span><br><span class="line"># ip netns exec ns1 ip link set lo up</span><br><span class="line"># ip netns exec ns1 ip  addr add  172.17.1.1/24 dev eth0</span><br><span class="line"># ip netns exec ns1 ip  route add default via 172.17.1.254</span><br></pre></td></tr></table></figure></p>
<p>此时可ping通宿主机所有ip地址，即使没开启路由转发和iptables 地址转换<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># iptables -t nat -I POSTROUTING -s 172.17.1.0/24 ! -d  172.17.1.0/24 -j MASQUERADE</span><br><span class="line"># sed -i &apos;/ipv4.ip/cnet.ipv4.ip_forward=1&apos;  /etc/sysctl.conf</span><br><span class="line">#sysctl -p</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>kubernetes网络更加复杂，以后总结.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2022/02/15/network-01/" data-id="cl1oueuur005d0ojx95ygsw85" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-gitlab-install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/20/gitlab-install/" class="article-date">
  <time datetime="2021-11-20T02:51:41.000Z" itemprop="datePublished">2021-11-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CICD/">CICD</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/20/gitlab-install/">gitlab install</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>找到源，下载一个想要的版本即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.bfsu.edu.cn/gitlab-ce/yum/el7/</span><br><span class="line">yum install https://mirrors.bfsu.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.5.0-ce.0.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>修改配置文件,做好域名解析，禁用不必要的prometheus组件<br>vim  /etc/gitlab/gitlab.rb<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">external_url &apos;http://gitlab.do.com&apos;</span><br><span class="line">prometheus[&apos;enable&apos;] = false</span><br><span class="line">alertmanager[&apos;enable&apos;] = false</span><br><span class="line">node_exporter[&apos;enable&apos;] = false</span><br><span class="line">redis_exporter[&apos;enable&apos;] = false</span><br><span class="line">postgres_exporter[&apos;enable&apos;] = false</span><br><span class="line">gitlab_exporter[&apos;enable&apos;] =false</span><br><span class="line">grafana[&apos;enable&apos;] = false</span><br></pre></td></tr></table></figure></p>
<p>跟据配置安装各组件启动服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl  reconfigure</span><br></pre></td></tr></table></figure></p>
<p>启动后运行的进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 hello]# gitlab-ctl  status </span><br><span class="line">run: gitaly: (pid 15538) 2771s; run: log: (pid 13341) 2932s    </span><br><span class="line">run: gitlab-workhorse: (pid 15246) 2778s; run: log: (pid 14693) 2824s</span><br><span class="line">run: logrotate: (pid 13071) 2952s; run: log: (pid 13101) 2948s</span><br><span class="line">run: nginx: (pid 14772) 2819s; run: log: (pid 14809) 2817s  port  80/8060</span><br><span class="line">run: postgresql: (pid 13552) 2924s; run: log: (pid 13581) 2921s</span><br><span class="line">run: puma: (pid 12664) 266s; run: log: (pid 14527) 2836s</span><br><span class="line">run: redis: (pid 13205) 2941s; run: log: (pid 13236) 2938s</span><br><span class="line">run: sidekiq: (pid 12559) 274s; run: log: (pid 14610) 2830s</span><br></pre></td></tr></table></figure></p>
<p>占用端口明细,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:9229  gitlab-workhorse</span><br><span class="line">127.0.0.1:9999  postgres</span><br><span class="line">::1:9999        postgres</span><br><span class="line">127.0.0.1:8080  puma 5.3.2</span><br><span class="line">0.0.0.0:80      nginx</span><br><span class="line">0.0.0.0:8060    nginx</span><br><span class="line">127.0.0.1:8082  sidekiq 6.2.2 </span><br><span class="line">127.0.0.1:9236  gitaly</span><br></pre></td></tr></table></figure></p>
<p>备份恢复<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# gitlab-backup    create</span><br><span class="line">[root@node01 ~]# gitlab-backup    restore</span><br></pre></td></tr></table></figure></p>
<p>同项目组协同开发</p>
<ul>
<li>同公司或同部门内部开发一个项目时，项目内成员拥有读写权限.</li>
<li>那么就要在此项目下邀请成员，并邀请时给定角色为Maintainer才可推送成功</li>
</ul>
<p>跨公司协同开发</p>
<ul>
<li>跨公司协作时不能邀请为成员，权限过大，此时采用另一种方式Fork.</li>
<li>三方成员账号下访问给定项目，并Fork到自己远程仓库里，那么三方成员对自己仓库代码拥有读写权限.</li>
<li>待开发完成，再访问原有项目，在原有项目上发起Merge Request或Pull request,意思是请求把自己仓库下的代码合并到项目上，等管理员批准并合并代码完成协同开发。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>学习</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2021/11/20/gitlab-install/" data-id="cl1oueupf001b0ojxm6ebb3wl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-jenkins-pipeline" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/20/jenkins-pipeline/" class="article-date">
  <time datetime="2021-11-20T02:21:41.000Z" itemprop="datePublished">2021-11-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CICD/">CICD</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/20/jenkins-pipeline/">jenkins pipeline</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2021/11/20/jenkins-pipeline/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2021/11/20/jenkins-pipeline/" data-id="cl1oueuqb001p0ojxsnm0kp93" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-jenkins-install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/19/jenkins-install/" class="article-date">
  <time datetime="2021-11-19T02:51:41.000Z" itemprop="datePublished">2021-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CICD/">CICD</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/19/jenkins-install/">jenkins install</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>清华源自行安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.bfsu.edu.cn/jenkins/redhat-stable/</span><br><span class="line">yum install  https://mirrors.bfsu.edu.cn/jenkins/redhat-stable/jenkins-2.303.3-1.1.noarch.rpm</span><br></pre></td></tr></table></figure></p>
<p>修改配置文件/etc/sysconfig/jenkins<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# cat /etc/sysconfig/jenkins  | grep -v ^# | grep -v ^$</span><br><span class="line">JENKINS_HOME=&quot;/var/lib/jenkins&quot;</span><br><span class="line">JENKINS_JAVA_CMD=&quot;&quot;</span><br><span class="line">JENKINS_USER=&quot;jenkins&quot;</span><br><span class="line">JENKINS_JAVA_OPTIONS=&quot;-Djava.awt.headless=true&quot;</span><br><span class="line">JENKINS_PORT=&quot;5081&quot;   # 不要冲突</span><br><span class="line">JENKINS_LISTEN_ADDRESS=&quot;&quot;</span><br><span class="line">JENKINS_HTTPS_PORT=&quot;&quot;</span><br><span class="line">JENKINS_HTTPS_KEYSTORE=&quot;&quot;</span><br><span class="line">JENKINS_HTTPS_KEYSTORE_PASSWORD=&quot;&quot;</span><br><span class="line">JENKINS_HTTPS_LISTEN_ADDRESS=&quot;&quot;</span><br><span class="line">JENKINS_HTTP2_PORT=&quot;&quot;</span><br><span class="line">JENKINS_HTTP2_LISTEN_ADDRESS=&quot;&quot;</span><br><span class="line">JENKINS_DEBUG_LEVEL=&quot;5&quot;</span><br><span class="line">JENKINS_ENABLE_ACCESS_LOG=&quot;no&quot;</span><br><span class="line">JENKINS_HANDLER_MAX=&quot;100&quot;</span><br><span class="line">JENKINS_HANDLER_IDLE=&quot;20&quot;</span><br><span class="line">JENKINS_EXTRA_LIB_FOLDER=&quot;&quot;</span><br><span class="line">JENKINS_ARGS=&quot;&quot;</span><br></pre></td></tr></table></figure></p>
<p>启动服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# systemctl  start jenkins</span><br></pre></td></tr></table></figure></p>
<p>或者直接下载jar包直接启动</p>
<p>或者官方yum安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/jenkins.repo \</span><br><span class="line">    https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum upgrade</span><br><span class="line">yum install epel-release java-11-openjdk-devel</span><br><span class="line">yum install jenkins</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure></p>
<p>如果安装插件比较慢，可以更新update.json文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost jenkins]# sed -i  &apos;s@https://updates.jenkins.io/download/@https://mirrors.bfsu.edu.cn/jenkins/@g&apos; updates/default.json </span><br><span class="line">[root@localhost jenkins]# sed -i  &apos;s@https://updates.jenkins.io/update-center.json@https://mirrors.bfsu.edu.cn/jenkins/updates/update-center.json@i&apos; hudson.model.UpdateCenter.xml</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>学习</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2021/11/19/jenkins-install/" data-id="cl1oueuq8001o0ojxwk3mghgj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-jenkins_mvn" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/25/jenkins_mvn/" class="article-date">
  <time datetime="2021-10-25T00:48:04.000Z" itemprop="datePublished">2021-10-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CICD/">CICD</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/25/jenkins_mvn/">jenkins容器里安装maven</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2021/10/25/jenkins_mvn/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2021/10/25/jenkins_mvn/" data-id="cl1oueuqi001u0ojx0n9tw310" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-linux-note个人小记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/15/linux-note个人小记/" class="article-date">
  <time datetime="2021-10-15T01:32:54.000Z" itemprop="datePublished">2021-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/15/linux-note个人小记/">linux个人小记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bridge fdb  add  $mac dev $ethx</span><br></pre></td></tr></table></figure>
<p>执行命令 cat /proc/buddyinfo 查看 slab，系统不存在大块内存时返回0数量较多<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/buddyinfo</span><br></pre></td></tr></table></figure></p>
<p>周期性地或者在发现大块内存不足时，先进行 drop_cache 操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure></p>
<p>必要时执行以下操作进行内存整理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/vm/compact_memory</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">执行命令 atop ，查看当前磁盘 IO 状态</span><br><span class="line">磁盘 sda 显示 busy 100% ，表示已达到严重性能瓶颈，继续在该界面按 d，可查看哪些进程正在使用磁盘 IO</span><br><span class="line">iotop -oPa查看哪些进程占用磁盘 IO</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2021/10/15/linux-note个人小记/" data-id="cl1oueutw003w0ojxdn926epa" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-harbor-install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/08/20/harbor-install/" class="article-date">
  <time datetime="2021-08-20T02:51:41.000Z" itemprop="datePublished">2021-08-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CICD/">CICD</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/20/harbor-install/">harbor install</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一-基本安装过程"><a href="#一-基本安装过程" class="headerlink" title="一. 基本安装过程"></a>一. 基本安装过程</h3><p>下载离线harbor Tar包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/goharbor/harbor/</span><br><span class="line">https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz</span><br></pre></td></tr></table></figure></p>
<p>解压后进入主目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure></p>
<p>编辑几个参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hostname: harbor.do.com</span><br><span class="line">http:</span><br><span class="line">  port: 5080</span><br><span class="line">https:</span><br><span class="line">  port: 443</span><br><span class="line">  certificate: /opt/harbor/certs/harbor.do.com.crt</span><br><span class="line">  private_key: /opt/harbor/certs/harbor.do.com.key </span><br><span class="line">harbor_admin_password: admin</span><br><span class="line">data_volume: /data</span><br></pre></td></tr></table></figure></p>
<p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]# rm  -rf /data</span><br><span class="line">[root@harbor harbor]# ./prepare </span><br><span class="line">[root@harbor harbor]# ./install.sh </span><br><span class="line">[root@harbor harbor]# docker-compose  down -v</span><br><span class="line">[root@harbor harbor]# docker-compose  up -d</span><br></pre></td></tr></table></figure></p>
<p>证书docker目录下也保留一份用于认证到harbor<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]# ls /etc/docker/certs.d/harbor.do.com/</span><br><span class="line">ca.crt  harbor.do.com.cert  harbor.do.com.key</span><br></pre></td></tr></table></figure></p>
<h3 id="二-证书细节"><a href="#二-证书细节" class="headerlink" title="二. 证书细节"></a>二. 证书细节</h3><p>如果有https证书的需求，需要额外几个步骤制作证书，这里记录说明.</p>
<p>harbor证书需要一个SAN/alternative_NAME的证书扩展的玩意，一般的openssl证书还不行，严格按照官网来.</p>
<ol>
<li><p>生成CA key.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.key 4096</span><br></pre></td></tr></table></figure>
</li>
<li><p>自签CA证书</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.done.com&quot; -key ca.key -out ca.crt</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p>生成服务器key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out harbor.done.com.key 4096</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成服务器csr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -sha512 -new -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.done.com&quot; -key harbor.done.com.key  -out harbor.done.com.csr</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成v3的玩意儿</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1=harbor.done.com</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p>签发服务器证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -sha512 -days 3650     -extfile v3.ext     -CA ca.crt -CAkey ca.key -CAcreateserial -in harbor.done.com.csr -out harbor.done.com.crt</span><br></pre></td></tr></table></figure>
</li>
<li><p>证书转换<br>放置docker端docker会认crt为CA证书，cert为客户端证书，所以不能直接放harbor.done.com.crt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -inform PEM -in harbor.done.com.crt -out  harbor.done.com.cert</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用证书<br>harbor程序使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:</span><br><span class="line">  # https port for harbor, default is 443</span><br><span class="line">  port: 443</span><br><span class="line">  # The path of cert and key files for nginx</span><br><span class="line">  certificate: /opt/harbor/certs/harbor.done.com.crt</span><br><span class="line">  private_key: /opt/harbor/certs/harbor.done.com.key</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>docker Daemon使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@node:~# ll /etc/docker/certs.d/harbor.done.com/</span><br><span class="line">total 20</span><br><span class="line">-rw------- 1 root root 2037 Nov 26 03:49 ca.crt</span><br><span class="line">-rw------- 1 root root 2074 Nov 26 03:49 harbor.done.com.cert</span><br><span class="line">-rw------- 1 root root 3243 Nov 26 03:49 harbor.done.com.key</span><br></pre></td></tr></table></figure></p>
<h4 id="三-k8s-secret"><a href="#三-k8s-secret" class="headerlink" title="三. k8s secret"></a>三. k8s secret</h4><p>除每个k8s node节点/etc/docker/certs/harbor.do.com/下保存证书外，如果harbor创建的仓库是私有仓库，那么k8s拉镜像时还是需要用户名密码保存在secret的.</p>
<p>创建secret<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred \</span><br><span class="line">  --docker-server=harbor.done.com  \</span><br><span class="line">  --docker-username=xx  \</span><br><span class="line">  --docker-password=xx  -n testns</span><br></pre></td></tr></table></figure></p>
<p>deployment引用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: demo</span><br><span class="line">  namespace: testns</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      workload.user.cattle.io/workloadselector: apps.deployment-testns-demo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        workload.user.cattle.io/workloadselector: apps.deployment-testns-demo</span><br><span class="line">    spec:</span><br><span class="line">      affinity: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.done.com/dev/spring:v1</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: container-x</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: port80</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure></p>
<h3 id="四-验证"><a href="#四-验证" class="headerlink" title="四. 验证"></a>四. 验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URL    https://harbor.do.com</span><br><span class="line">docker login harbor.do.com</span><br></pre></td></tr></table></figure>
<h3 id="五-总结"><a href="#五-总结" class="headerlink" title="五. 总结"></a>五. 总结</h3><p>参考：<a href="https://goharbor.io/docs/2.4.0/install-config/configure-https/" target="_blank" rel="noopener">https://goharbor.io/docs/2.4.0/install-config/configure-https/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2021/08/20/harbor-install/" data-id="cl1oueuq1001k0ojxhybc41tk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CICD/">CICD</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ceph/">Ceph</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GPU/">GPU</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mongodb/">Mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/">Openstack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Prometheus/">Prometheus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDjango开发/">WebDjango开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebFlask开发/">WebFlask开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebSocket/">WebSocket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web爬虫开发/">Web爬虫开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ansible/">ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/声明/">声明</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器世界/">容器世界</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志系统/">日志系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/03/12/nginx-upsync/">nginx upsync</a>
          </li>
        
          <li>
            <a href="/2022/02/15/log_elk_version_8.1.1/">ELF8.1填坑</a>
          </li>
        
          <li>
            <a href="/2022/02/15/gpu-01-初识/">GPU</a>
          </li>
        
          <li>
            <a href="/2022/02/15/network-01/">网络</a>
          </li>
        
          <li>
            <a href="/2021/11/20/gitlab-install/">gitlab install</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 wxq<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<!--
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
-->

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>